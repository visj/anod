function e(a,b){Object.defineProperty(a,"val",b)}function f(a,b,c){this.g=0|b;this.h=c;this.l=null;this.D=-1;this.v=this.m=null;null!==a&&(null===a.j?a.j=[this]:a.j.push(this))}function h(a,b){var c=a.l;a=a.m;null!==c&&k(c,b);if(null!==a){c=a.length;for(var d=0;d<c;d++)k(a[d],b)}}function l(a){a.g=256;a.h=void 0;a.l=null;a.m=null;a.v=null;null!==a.l&&(m(a.l,a.D),a.l=null);var b=a.m;if(null!==b){var c=b.length;for(a=a.v;0!==c--;)m(b.pop(),a.pop())}}
function n(){this.g=0;this.h=void 0;this.i=this.j=null}function p(a){this.g=256;this.h=void 0;var b,c,d=this.j,g=this.i;if(null!==d&&0!==(c=d.length))for(b=0;b<c;b++)d[b].u(a);this.j=null;if(null!==g&&0!==(c=g.length))for(b=0;b<c;b++)g[b](!0);this.i=null}e(n.prototype,{get:function(){return this.h}});n.prototype.B=q;n.prototype.u=p;function k(a,b){var c;if(a.C<b){if(null!==a.j&&0!==(c=a.j.length))for(;0!==c--;)a.j.pop().u(b);a.C=b;a.g|=32;r.add(a);0!==(a.g&1024)&&h(a,b)}}
function u(a){f.call(this,v,0,a);this.i=w}function x(){0===(this.g&320)&&null!==y&&A(this);return this.h}function B(a){var b=this.g;if(0===(b&320))if(0===E)0!==(b&1024)?(F(),this.i=a,this.g|=32,G.add(this),H()):this.h=a;else if(this.i===w)this.i=a,this.g|=32,G.add(this);else if(a!==this.i)throw Error("conflicting changes: "+a+" !== "+this.i);return a}function I(){this.h=this.i;this.i=w;this.g&=-33;0!==(this.g&1024)&&h(this,J)}function K(){l(this);this.i=void 0}e(u.prototype,{get:x,set:B});
u.prototype.B=I;u.prototype.u=K;function L(a,b){u.call(this,a);this.j=b||M}e(L.prototype,{get:x,set:function(a){0!==(this.g&320)||this.j(this.h,a)||B.call(this,a);return a}});L.prototype.B=I;L.prototype.u=function(){this.j=null;K.call(this)};function N(a,b,c){var d=v,g=y;f.call(this,d,c);this.C=0;this.o=null;this.F=0;this.i=this.j=this.A=this.s=null;this.G=a;v=y=this;if(0===E){F();E=1;try{this.h=a(b),(0<G.h||0<O.h)&&P()}finally{E=0,v=y=null}}else this.h=a(b);v=d;y=g}
e(N.prototype,{get:function(){var a=this.g;if(0===(a&320)&&0!==E){if(this.C===J){if(0!==(a&128))throw Error("circular dependency");this.B()}null!==y&&A(this)}return this.h}});N.prototype.B=function(){if(0!==(this.g&32)){var a=v,b=y;v=y=null;if(null!==this.i)for(var c=this.i.length;0!==c--;)this.i.pop()(!1);0===(this.g&16)&&Q(this);v=this;y=0!==(this.g&16)?null:this;this.g|=128;this.h=this.G(this.h);this.g&=-161;v=a;y=b}};N.prototype.u=function(a){this.G=null;this.C=a;p.call(this,a);l(this);Q(this)};
function R(a){this.j=a;this.i=[];this.h=0}R.prototype.add=function(a){this.i[this.h++]=a};function S(a,b){E=a.j;for(var c=0;c<a.h;++c){var d=a.i[c];0!==(d.g&32)?d.B():0!==(d.g&64)&&d.u(b);a.i[c]=null}a.h=0}var w={},J=0,E=0,O=new R(1),G=new R(2),U=new R(2),r=new R(4),v=null,y=null;function M(a,b){return a===b}function q(){}function F(){O.h=G.h=U.h=r.h=0}
function A(a){var b=y;a.g|=1024;var c=null===b.o?-1:null===b.s?0:b.s.length;if(null===a.l){a.l=b;a.D=c;var d=-1}else null===a.m?(a.m=[b],a.v=[c],d=0):(d=a.m.length,a.m.push(b),a.v.push(c));null===b.o?(b.o=a,b.F=d):null===b.s?(b.s=[a],b.A=[d]):(b.s.push(a),b.A.push(d))}function H(){var a=v;try{P()}finally{E=0,v=a,y=null}}function P(){var a=0;do{var b=++J;S(O,b);S(G,b);S(U,b);S(r,b);if(1E5<a++)throw Error("Cycle overflow");}while(0<G.h||0<O.h||0!==U.h||0!==r.h)}
function Q(a){null!==a.o&&(V(a.o,a.F),a.o=null);var b=a.s;if(null!==b){var c=b.length;for(a=a.A;0!==c--;)V(b.pop(),a.pop())}}function V(a,b){if(0===(a.g&320))if(-1===b)a.l=null;else{var c=a.m;a=a.v;var d=c.pop(),g=a.pop();b!==c.length&&(c[b]=d,a[b]=g,-1===g?d.F=b:d.A[g]=b)}}function m(a,b){if(0===(a.g&320))if(-1===b)a.o=null;else{var c=a.s;a=a.A;var d=c.pop(),g=a.pop();b!==c.length&&(c[b]=d,a[b]=g,-1===g?d.D=b:d.v[g]=b)}}var Opt={Defer:8,Static:16};
var root=function(a){var b=new n,c=v,d=y;v=b;y=null;if(0===E)try{b.h=a()}finally{v=c,y=d}else b.h=a(),v=c,y=d;return b};var dispose=function(a){0===(a.g&320)&&(0===E?a.u(J):(a.g|=64,O.add(a)))};var compute=function(a,b,c){return new N(a,b,c)};var effect=function(a,b,c){new N(a,b,c)};
var bind=function(a,b){var c=w,d,g,T=Array.isArray(a);if(T){var C=a.length;c=Array(C);var t=Array(C)}return function(D){void 0===d&&(y=v,y.g|=16,d=0!==(y.g&8));if(T)for(var z=0;z<C;z++)t[z]=a[z].val;else t=a.val;y=null;d?d=!1:D=b(t,D,c);g=t;t=c;c=g;return D}};var data=function(a){return new u(a)};var value=function(a,b){return new L(a,b)};var nil=function(){return w};var owner=function(){return v};var listener=function(){return y};
var freeze=function(a){if(0===E){F();E=1;try{var b=a();H()}finally{E=0}}else b=a();return b};var peek=function(a){var b=y;y=null;a="function"===typeof a?a():a.val;y=b;return a};var cleanup=function(a){var b=v;null!==b&&(null===b.i?b.i=[a]:b.i.push(a))};var Data=u;var Value=L;var Computation=N;

window.Zorn = { Opt: Opt, root: root, dispose: dispose, compute: compute, effect: effect, bind: bind, data: data, value: value, nil: nil, owner: owner, listener: listener, freeze: freeze, peek: peek, cleanup: cleanup, Data: Data, Value: Value, Computation: Computation };