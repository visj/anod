function f(a){this.g=a}g(f.prototype,{get:function(){return this.g()}});function g(a,b){Object.defineProperty(a,"val",b)}function k(a,b,c){this.h=0|b;this.i=c;this.m=null;this.G=-1;this.v=this.l=null;null!==a&&(null===a.g?a.g=[this]:a.g.push(this))}function l(a,b){var c,d=a.m;a=a.l;null!==d&&n(d,b);if(null!==a&&0<(c=a.length))for(d=0;d<c;d++)n(a[d],b)}
function p(a){a.h=2;a.i=void 0;a.m=null;a.l=null;a.v=null;var b,c=a.m,d=a.l;null!==c&&(q(c,a.G),a.m=null);if(null!==d&&0!==(b=d.length))for(a=a.v;0!==b--;)q(d.pop(),a.pop())}function t(){this.h=0;this.i=void 0;this.C=this.j=this.g=null}function u(a){this.h=2;this.i=void 0;var b,c,d=this.g,e=this.j;if(null!==d&&0!==(c=d.length))for(b=0;b<c;b++)d[b].s(a);this.g=null;if(null!==e&&0!==(c=e.length))for(b=0;b<c;b++)e[b](!0);this.j=null}g(t.prototype,{get:function(){return this.i}});t.prototype.B=function(){};
t.prototype.s=u;function n(a,b){var c=a.h;0===(c&6)&&a.u<b&&(a.u=b,a.h|=16,0!==(c&64)?v(w,a):v(x,a),null!==a.g&&y(a.g,b),0!==(c&32)&&l(a,b))}function y(a,b){for(var c=a.length,d=0;d<c;d++){var e=a[d];e.u=b;e.h=4;v(z,e);e=e.g;null!==e&&(y(e,b),e.length=0)}}function A(a){k.call(this,B,0,a);this.g=C}function D(){0===(this.h&6)&&null!==E&&G(this);return this.i}
function H(a){var b=this.h;if(0===(b&6))if(0===I)0!==(b&32)?(J(),this.i=a,l(this,K+1),L()):this.i=a;else if(this.g===C)this.g=a,this.h|=16,v(M,this);else if(a!==this.g)throw Error("Zorn: Conflict");return a}function N(a){this.i=this.g;this.g=C;this.h&=-17;0!==(this.h&32)&&l(this,a)}function O(){p(this);this.g=void 0}g(A.prototype,{get:D,set:H});A.prototype.B=N;A.prototype.s=O;function P(a,b){A.call(this,a);this.j=b}
g(P.prototype,{get:D,set:function(a){0===(this.h&6)&&((void 0===this.j?a===this.i:this.j(a,this.i))||H.call(this,a));return a}});P.prototype.B=N;P.prototype.s=function(){this.j=null;O.call(this)};function Q(a,b,c,d){var e=B,h=E;k.call(this,e,c);this.u=0;this.A=null;this.H=0;this.C=this.j=this.g=this.D=this.o=null;void 0!==d&&!1===d&&(this.h&=-65);this.F=a;B=E=this;if(0===I){J();I=1;try{this.i=a(b),0===M.g&&0===z.g||R()}finally{I=0,B=E=null}}else this.i=a(b);B=e;E=h}
g(Q.prototype,{get:function(){var a=this.h;if(0===(a&6)&&0!==I){if(this.u===K){if(0!==(a&8))throw Error();0!==(a&16)&&this.B(this.u)}null!==E&&G(this)}return this.i}});
Q.prototype.B=function(){var a,b,c=B,d=E;B=E=null;var e=this.h,h=this.j;if(null!==h&&0!==(b=h.length)){for(a=0;a<b;a++)h[a](!1);h.length=0}0===(e&1)&&S(this);B=this;E=0!==(e&1)?null:this;this.h|=8;e=this.C;if(null!==e)try{this.i=this.F(this.i)}catch(m){b=e.length;for(a=0;a<b;a++)e[a](m);e.length=0}else this.i=this.F(this.i);this.h&=-25;B=c;E=d};Q.prototype.s=function(a){this.F=null;this.u=a;u.call(this,a);p(this);S(this)};function T(a){this.j=a;this.l=[];this.g=0}function v(a,b){a.l[a.g++]=b}
function U(a,b){I=a.j;for(var c=0,d=0;d<a.g;d++){var e=a.l[d],h=e.h;if(0!==(h&20))try{0!==(h&16)?e.B(b):e.s(b)}catch(m){c=1,0!==(h&16)&&(e.i=m,e.h|=128)}a.l[d]=null}a.g=0;return c}var C={},K=0,I=0,z=new T(2),M=new T(3),w=new T(4),x=new T(5),B=null,E=null;function J(){z.g=M.g=w.g=x.g=0}
function G(a){var b=E;a.h|=32;var c=null===b.A?-1:null===b.o?0:b.o.length;if(null===a.m){a.m=b;a.G=c;var d=-1}else null===a.l?(a.l=[b],a.v=[c],d=0):(d=a.l.length,a.l.push(b),a.v.push(c));null===b.A?(b.A=a,b.H=d):null===b.o?(b.o=[a],b.D=[d]):(b.o.push(a),b.D.push(d))}function L(){var a=B;try{R()}finally{I=0,B=a,E=null}}
function R(){var a=0,b=0;do{var c=++K;0!==z.g&&(b+=U(z,c));0!==M.g&&(b+=U(M,c));0!==z.g&&(b+=U(z,c));0!==w.g&&(b+=U(w,c));0!==x.g&&(b+=U(x,c));if(0!==b)throw Error("Zorn: Error");if(1E5<a++)throw Error("Zorn: Cycle");}while(0!==M.g||0!==z.g||0!==w.g||0!==x.g)}function S(a){var b,c=a.A,d=a.o;null!==c&&(V(c,a.H),a.A=null);if(null!==d&&0!==(b=d.length))for(a=a.D;0!==b--;)V(d.pop(),a.pop())}
function V(a,b){if(0===(a.h&6))if(-1===b)a.m=null;else{var c=a.l;a=a.v;var d=c.pop(),e=a.pop();b!==c.length&&(c[b]=d,a[b]=e,-1===e?d.H=b:d.D[e]=b)}}function q(a,b){if(0===(a.h&6))if(-1===b)a.A=null;else{var c=a.o;a=a.D;var d=c.pop(),e=a.pop();b!==c.length&&(c[b]=d,a[b]=e,-1===e?d.G=b:d.v[e]=b)}}export var root=function(a){var b=new t,c=B,d=E;B=b;E=null;if(0===I)try{b.i=a()}finally{B=c,E=d}else b.i=a(),B=c,E=d;return b},dispose=function(a){var b=a.h;0===(b&6)&&(0===I?a.s(K):(a.h=b&-17|4,v(z,a)))},val=function(a){return new f(a)},compute=function(a,b,c){return new Q(a,b,1,c)},$compute=function(a,b,c){return new Q(a,b,0,c)}
,when=function(a,b,c){var d=Array.isArray(a);if(d){var e=a.length;var h=Array(e);var m=Array(e)}return function(F){if(d)for(var r=0;r<e;r++)m[r]=a[r].val;else m=a.val;c?c=!1:(E=null,F=b(m,F,h));r=m;m=h;h=r;return F}},data=function(a){return new A(a)},value=function(a,b){return new P(a,b)},nil=function(){return C},owner=function(){return B},listener=function(){return E},freeze=function(a){if(0===I){J();I=1;try{var b=a();L()}finally{I=0}}else b=a();return b}
,recover=function(a){var b=B;null!==b&&(null===b.C?b.C=[a]:b.C.push(a))},peek=function(a){var b=E;E=null;a=a.val;E=b;return a},cleanup=function(a){var b=B;null!==b&&(null===b.j?b.j=[a]:b.j.push(a))},Data=A,Value=P,Computation=Q;
