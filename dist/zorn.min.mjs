function f(a){this.g=a}g(f.prototype,{get:function(){return this.g()}});function g(a,b){Object.defineProperty(a,"val",b)}function k(a,b,c){this.h=0|b;this.i=c;this.m=null;this.G=-1;this.v=this.l=null;null!==a&&(null===a.g?a.g=[this]:a.g.push(this))}function l(a,b){var c,d=a.m;a=a.l;null!==d&&n(d,b);if(null!==a&&0<(c=a.length))for(d=0;d<c;d++)n(a[d],b)}
function p(a){a.h=2;a.i=void 0;a.m=null;a.l=null;a.v=null;var b,c=a.m,d=a.l;null!==c&&(q(c,a.G),a.m=null);if(null!==d&&0!==(b=d.length))for(a=a.v;0!==b--;)q(d.pop(),a.pop())}function t(){this.h=0;this.i=void 0;this.C=this.j=this.g=null}function u(a){this.h=2;this.i=void 0;var b,c,d=this.g,e=this.j;if(null!==d&&0!==(c=d.length))for(b=0;b<c;b++)d[b].s(a);this.g=null;if(null!==e&&0!==(c=e.length))for(b=0;b<c;b++)e[b](!0);this.j=null}g(t.prototype,{get:function(){return this.i}});t.prototype.B=function(){};
t.prototype.s=u;function n(a,b){var c=a.h;0===(c&6)&&a.u<b&&(a.u=b,a.h|=16,0!==(c&64)?v.add(a):w.add(a),null!==a.g&&x(a.g,b),0!==(c&32)&&l(a,b))}function x(a,b){for(var c=a.length,d=0;d<c;d++){var e=a[d];e.u=b;e.h=4;y.add(e);e=e.g;null!==e&&(x(e,b),e.length=0)}}function z(a){k.call(this,A,0,a);this.g=B}function C(){0===(this.h&6)&&null!==D&&F(this);return this.i}
function G(a){var b=this.h;if(0===(b&6))if(0===H)0!==(b&32)?(I(),this.i=a,l(this,J+1),K()):this.i=a;else if(this.g===B)this.g=a,this.h|=16,L.add(this);else if(a!==this.g)throw Error("Zorn: Conflict");return a}function M(a){this.i=this.g;this.g=B;this.h&=-17;0!==(this.h&32)&&l(this,a)}function N(){p(this);this.g=void 0}g(z.prototype,{get:C,set:G});z.prototype.B=M;z.prototype.s=N;function O(a,b){z.call(this,a);this.j=b}
g(O.prototype,{get:C,set:function(a){0===(this.h&6)&&((void 0===this.j?a===this.i:this.j(a,this.i))||G.call(this,a));return a}});O.prototype.B=M;O.prototype.s=function(){this.j=null;N.call(this)};function P(a,b,c,d){var e=A,h=D;k.call(this,e,c);this.u=0;this.A=null;this.H=0;this.C=this.j=this.g=this.D=this.o=null;void 0!==d&&!1===d&&(this.h&=-65);this.F=a;A=D=this;if(0===H){I();H=1;try{this.i=a(b),0===L.g&&0===y.g||Q()}finally{H=0,A=D=null}}else this.i=a(b);A=e;D=h}
g(P.prototype,{get:function(){var a=this.h;if(0===(a&6)&&0!==H){if(this.u===J){if(0!==(a&8))throw Error();0!==(a&16)&&this.B(this.u)}null!==D&&F(this)}return this.i}});
P.prototype.B=function(){var a,b,c=A,d=D;A=D=null;var e=this.h,h=this.j;if(null!==h&&0!==(b=h.length)){for(a=0;a<b;a++)h[a](!1);h.length=0}0===(e&1)&&R(this);A=this;D=0!==(e&1)?null:this;this.h|=8;e=this.C;if(null!==e)try{this.i=this.F(this.i)}catch(m){b=e.length;for(a=0;a<b;a++)e[a](m);e.length=0}else this.i=this.F(this.i);this.h&=-25;A=c;D=d};P.prototype.s=function(a){this.F=null;this.u=a;u.call(this,a);p(this);R(this)};function S(a){this.j=a;this.l=[];this.g=0}
S.prototype.add=function(a){this.l[this.g++]=a};function T(a,b){H=a.j;for(var c=0,d=0;d<a.g;d++){var e=a.l[d],h=e.h;if(0!==(h&20))try{0!==(h&16)?e.B(b):e.s(b)}catch(m){c=1,0!==(h&16)&&(e.i=m,e.h|=128)}a.l[d]=null}a.g=0;return c}var B={},J=0,H=0,y=new S(2),L=new S(3),v=new S(4),w=new S(5),A=null,D=null;function I(){y.g=L.g=v.g=w.g=0}
function F(a){var b=D;a.h|=32;var c=null===b.A?-1:null===b.o?0:b.o.length;if(null===a.m){a.m=b;a.G=c;var d=-1}else null===a.l?(a.l=[b],a.v=[c],d=0):(d=a.l.length,a.l.push(b),a.v.push(c));null===b.A?(b.A=a,b.H=d):null===b.o?(b.o=[a],b.D=[d]):(b.o.push(a),b.D.push(d))}function K(){var a=A;try{Q()}finally{H=0,A=a,D=null}}
function Q(){var a=0,b=0;do{var c=++J;0!==y.g&&(b+=T(y,c));0!==L.g&&(b+=T(L,c));0!==y.g&&(b+=T(y,c));0!==v.g&&(b+=T(v,c));0!==w.g&&(b+=T(w,c));if(0!==b)throw Error("Zorn: Error");if(1E5<a++)throw Error("Zorn: Cycle");}while(0!==L.g||0!==y.g||0!==v.g||0!==w.g)}function R(a){var b,c=a.A,d=a.o;null!==c&&(U(c,a.H),a.A=null);if(null!==d&&0!==(b=d.length))for(a=a.D;0!==b--;)U(d.pop(),a.pop())}
function U(a,b){if(0===(a.h&6))if(-1===b)a.m=null;else{var c=a.l;a=a.v;var d=c.pop(),e=a.pop();b!==c.length&&(c[b]=d,a[b]=e,-1===e?d.H=b:d.D[e]=b)}}function q(a,b){if(0===(a.h&6))if(-1===b)a.A=null;else{var c=a.o;a=a.D;var d=c.pop(),e=a.pop();b!==c.length&&(c[b]=d,a[b]=e,-1===e?d.G=b:d.v[e]=b)}}export var root=function(a){var b=new t,c=A,d=D;A=b;D=null;if(0===H)try{b.i=a()}finally{A=c,D=d}else b.i=a(),A=c,D=d;return b},dispose=function(a){var b=a.h;0===(b&6)&&(0===H?a.s(J):(a.h=b&-17|4,y.add(a)))},val=function(a){return new f(a)},compute=function(a,b,c){return new P(a,b,65,c)},$compute=function(a,b,c){return new P(a,b,64,c)},effect=function(a,b){new P(a,b,1)},$effect=function(a,b){new P(a,b,0)}
,when=function(a,b,c){var d=Array.isArray(a);if(d){var e=a.length;var h=Array(e);var m=Array(e)}return function(E){if(d)for(var r=0;r<e;r++)m[r]=a[r].val;else m=a.val;c?c=!1:(D=null,E=b(m,E,h));r=m;m=h;h=r;return E}},data=function(a){return new z(a)},value=function(a,b){return new O(a,b)},nil=function(){return B},owner=function(){return A},listener=function(){return D},freeze=function(a){if(0===H){I();H=1;try{var b=a();K()}finally{H=0}}else b=a();return b}
,recover=function(a){var b=A;null!==b&&(null===b.C?b.C=[a]:b.C.push(a))},peek=function(a){var b=D;D=null;a=a.val;D=b;return a},cleanup=function(a){var b=A;null!==b&&(null===b.j?b.j=[a]:b.j.push(a))},Data=z,Value=O,Computation=P;
